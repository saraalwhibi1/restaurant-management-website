<!DOCTYPE html>

<html lang="en" class="theme-1">

  <head>
    <meta charset="UTF-8" />
    <title>Manage Me</title>
    <link rel="stylesheet" href="css/style.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="js/jquery.js"></script>
    <script src="js/script.js"></script>
  </head>


  <body>


    <header class="line">
      <div class="logo left">
        <img src="mmimages/mmlogo.png" alt="MANAGE ME LOGO" width = "150" height = "100" >
      </div>

      <div class='themes'>
        <button onclick="setTheme('theme-1')" class="btn-primary">Dark mode</button>
        <button onclick="setTheme('theme-2')" class="btn-primary">Light mode</button>
      </div>
      
      <nav class="right">
        <div class="line">
          <div class="top-nav">
            <p class="nav-text" onclick="togleTopNav();"></p>
            <div id="top_nav_menu">
              <ul class="right dropdown">
                <li class="active-item">
                  <a href="index.html" accesskey="h">Home</a></li>
                <li><a href="reservations.html" accesskey="r">Reservations</a></li>
                <li><a href="menu.html" accesskey="m">Menu</a></li>
                <li><a href="orders.html" accesskey="o">Orders</a></li>
                <li><a href="ourstaff.html" accesskey="s">Our Staff</a></li>
              </ul>
            </div>
          </div>
        </div>
      </nav>

      <div class="breadcrumbs line">
        <p><a href="index.html">Home</a> &#62; Orders</p>
      </div>
    </header>


    <div class="ordersmain">
    <div class="page line">
      <div class="wrapper">

        <main class="content-wrapper">

          <div class="left-content Odetails">
            <h1 class="center-text">Orders</h1>

            <h3 class="orderh3">
              Reserved Tables
              <select id="Reserved" name="Reserved">
                <script>
                for (var i = 0; i < localStorage.length; i++) {
                  if (localStorage.key(i).includes("reserved_tables_"))
                  document.write("<option>" + localStorage.key(i).replace("reserved_tables_", "") + "</option>");
                }
                
                $('#Reserved').change(function(){
                    $('.results-row input').val('0');
                });
                
                </script>

              </select>
            </h3>
            <br /><br />

            <div class="OrRow">
              <div class="OrCol">
                <form class="Odishes">
                  <div class="tab-content">
                    <div id="div_menu_results" class="tab-pane">

                      <div class="Ocat">Main Dishes:</div>
                      <button
                        id="sort"
                        type="button"
                        class="btn btn-primary sortByPrice sortByPrice1"
                      >
                        Sort by price
                      </button>
                      <div class="results1">
                        <div class="results-row">
                          <span class="name">Dragoon roll </span> (
                          <strong class="label label-info price">30 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Unagi Sushi </span> (
                          <strong class="label label-info price">40 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Sashimi </span> (
                          <strong class="label label-info price">25 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Signature</span>(
                          <strong class="label label-info price">45 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>
                      </div>
                    </div>

                    <div id="div_menu_results" class="tab-pane">
                      <div class="Ocat">Sweets:</div>
                      <button
                        id="sort"
                        type="button"
                        class="btn btn-primary sortByPrice sortByPrice2"
                      >
                        Sort by price
                      </button>
                      <div class="results2">
                        <div class="results-row">
                          <span class="name">Souffle </span> (
                          <strong class="label label-info price">35 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Pancakes </span> (
                          <strong class="label label-info price">30 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Mizu Yokan </span> (
                          <strong class="label label-info price">44 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Taiyaki </span>(
                          <strong class="label label-info price">25 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>
                      </div>
                    </div>

                    <div id="div_menu_results" class="tab-pane">
                      <div class="Ocat">Drinks:</div>
                      <button
                        id="sort"
                        type="button"
                        class="btn btn-primary sortByPrice sortByPrice3"
                      >
                        Sort by price
                      </button>
                      <div class="results3">
                        <div class="results-row">
                          <span class="name">Mix Berries </span> (
                          <strong class="label label-info price">22 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Pomegranate Refresher </span> (
                          <strong class="label label-info price">25 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Matcha Way </span> (
                          <strong class="label label-info price">30 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Signature Mojito </span>(
                          <strong class="label label-info price">20 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Latte </span>(
                          <strong class="label label-info price">15 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>

                        <div class="results-row">
                          <span class="name">Water </span>(
                          <strong class="label label-info price">6 .SR</strong>)
                          -
                          <label for="quantity" class="dish1quan">
                            Quantity:</label
                          >
                          <input
                            type="number"
                            id="quantity"
                            name="quantity"
                            class="quantity"
                            value="0"
                            min="1"
                            max="5"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="center-text">
                      <button
                        id="sort"
                        type="button"
                        class="btn btn-primary calcTota"
                      >
                        Order
                      </button>
                    </div>
                  </div>

                  
                  <script>
                    var ascending1 = false;
                    var ascending2 = false;
                    var ascending3 = false;

                    $(".tab-content").on("click", ".sortByPrice1", function () {
                      var results = $(".results1");
                      var sorted = results
                        .find(".results-row")
                        .sort(function (a, b) {
                          return ascending1 ==
                            convertToNumber($(a).find(".price").html()) <
                              convertToNumber($(b).find(".price").html())
                            ? 1
                            : -1;
                        });
                      ascending1 = ascending1 ? false : true;

                      results.html(sorted);
                    });

                    $(".tab-content").on("click", ".sortByPrice2", function () {
                      var results = $(".results2");
                      var sorted = results
                        .find(".results-row")
                        .sort(function (a, b) {
                          return ascending2 ==
                            convertToNumber($(a).find(".price").html()) <
                              convertToNumber($(b).find(".price").html())
                            ? 1
                            : -1;
                        });
                      ascending2 = ascending2 ? false : true;

                      $(".results2").html(sorted);
                    });

                    $(".tab-content").on("click", ".sortByPrice3", function () {
                      var results = $(".results3");
                      var sorted = results
                        .find(".results-row")
                        .sort(function (a, b) {
                          return ascending3 ==
                            convertToNumber($(a).find(".price").html()) <
                              convertToNumber($(b).find(".price").html())
                            ? 1
                            : -1;
                        });
                        ascending3 = ascending3 ? false : true;

                      $(".results3").html(sorted);
                    });

                    var convertToNumber = function (value) {
                      return parseFloat(value.replace(".SR", ""));
                    };

                    $(".tab-content").on("click", ".calcTota", () =>
                      calculateTotals()
                    );

                    function calculateTotals() {
                      const reserved = $("#Reserved").find(":selected").text();

                      if (!reserved) {
                        alert("Please, select the table.");
                        return;
                      }

                      var table = $("#invoice-total-" + reserved);

                      if (table.length == 0) {
                        addTable(reserved);
                        table = $("#invoice-total-" + reserved);
                      }
                      table.find("tbody").html("");
                      const subtotals = $(".results-row")
                        .map((idx, val) => calculateSubtotal(table, val))
                        .get();
                      const total = subtotals.reduce(
                        (a, v) => a + Number(v),
                        0
                      );

                      table
                        .find("tfoot")
                        .find("tr")
                        .find("td")
                        .text("Total: " + formatAsCurrency(total) + " .SR");

                      table.find(".tableNumber").text("Table#" + reserved);

                      if (total == 0) {
                        $('#order-table-' + reserved).remove();
                        alert("You must select an item.");
                      } else {//
                        //orderTable(reserved);
                        $('.results-row input').val('0');
                      }
                    }

                    function calculateSubtotal(table, item) {
                      const $table = $(table);
                      const $item = $(item);
                      const name = $item.find(".name").text();
                      const price = convertToNumber(
                        $item.find(".price").text()
                      );
                      const quantity = $item.find(".quantity")[0].value;

                      if (quantity == 0) return;
                      console.log(quantity);
                      const subtotal = price * quantity;

                      var row =
                        "<tr> <td>" +
                        name +
                        "</td> <td>" +
                        quantity +
                        "</td> <td>" +
                        formatAsCurrency(subtotal) +
                        " .SR</td> </tr>";
                      table.find("tbody").append(row);

                      return subtotal;
                    }

                    function formatAsCurrency(amount) {
                      return `${Number(amount).toFixed(2)}`;
                    }

                    function addTable(num) {
                      var table =
                        '<div id="order-table-' + num + '" class="orderTable">' +
                        '<table id="invoice-total-' +
                        num +
                        '" style="width: 90%">' +
                        "<thead>" +
                        "<tr>" +
                        '<th colspan="3" class="tableNumber">Table#' +
                        num +
                        "</th>" +
                        "</tr>" +
                        "<tr>" +
                        "<th>Item</th>" +
                        "<th>Quantity</th>" +
                        "<th>Price</th>" +
                        "</tr>" +
                        "</thead>" +
                        "<tbody>" +
                        "</tbody>" +
                        "<tfoot>" +
                        "<tr>" +
                        '<td colspan="3">Total:</td>' +
                        "</tr>" +
                        "</tfoot>" +
                        "</table>" +
                        '<div class="center-text">' +
                        '<input type="reset" onClick="cancelTable(\'' + num + '\')" value="Cancel" />' +
                        '<input type="submit" onClick="printTable(\'' + num +'\')" value="Print Invoice" />' +
                        "</div>";

                      $("#invoicesOrders").append(table);
                       $("#pastOrders").append(table);
                    }
                       
                    function cancelTable(num){
                    console.log(num);
                       localStorage.removeItem("reserved_tables_" + num);
                      

                        $("#order-table-" + num).remove();
                    }

                    function printTable(num) {console.log(num);
                      $("#Reserved option[value='" + num +"']").each(function() {
                            $(this).remove();
                        });
                      var divToPrint = document.getElementById(
                        "order-table-" + num
                      );

                      var newWin = window.open("", "Print-Window");

                      newWin.document.open();

                      newWin.document.write(
                        '<html><body onload="window.print()">' +
                          divToPrint.innerHTML +
                          "</body></html>"
                      );

                      newWin.document.close();

                      setTimeout(function () {
                        newWin.close();
                      }, 10);

                      localStorage.removeItem("reserved_tables_" + num);
                      

                        $("#order-table-" + num).remove();
                    }

                    function orderTable(id) {
                        localStorage.removeItem("reserved_tables_" + id);
                        $("#Reserved option[value='" + id +"']").each(function() {
                            $(this).remove();
                        });
                    }
                    
                   
                  </script>
                </form>
                <br />
              </div>
            </div>
          </div>

        </main>

        <aside class="sidebar location invoice" style = "overflow: auto;">
          <h1 class="center-text">Invoice</h1>
          <div id="invoicesOrders">
           
          </div>
          <br /><br />
        </aside>
      </div>
    </div>
    </div>
    

    <footer>
      <p>&#169;2021 Manage Me All rights reserved.</p>
    </footer>

  </body>

</html>
